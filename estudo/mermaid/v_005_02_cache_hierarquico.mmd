sequenceDiagram
    participant Client as ğŸ“± Client App
    participant LB as âš–ï¸ Load Balancer
    participant L1 as ğŸš€ Cache L1 (Redis)
    participant L2 as ğŸ’¾ Cache L2 (Cosmos)
    participant Config as âš™ï¸ Config Service
    participant Monitor as ğŸ“Š Azure Monitor
    participant Security as ğŸ”’ Security Layer

    Note over Client, Security: Cache HierÃ¡rquico com SeguranÃ§a CibernÃ©tica<br/>Conformidade ResoluÃ§Ã£o CMN 4.893/2021

    Client->>+Security: Request com autenticaÃ§Ã£o
    Security->>Security: Validar certificados TLS
    Note right of Security: Art. 3Âº, Â§ 2Âº - Criptografia obrigatÃ³ria
    Security-->>Client: ConexÃ£o segura estabelecida
    
    Client->>+LB: GET /parameters/{id}
    LB->>+L1: Verificar cache local
    
    alt Cache L1 Hit
        L1-->>LB: âœ… Dados encontrados
        LB-->>Client: Resposta (latÃªncia ~2ms)
        L1->>+Monitor: Log cache hit L1
        Monitor-->>L1: MÃ©trica registrada
    else Cache L1 Miss
        L1-->>LB: âŒ Cache miss
        LB->>+L2: Verificar cache distribuÃ­do
        
        alt Cache L2 Hit
            L2-->>LB: âœ… Dados encontrados
            LB->>+L1: Atualizar cache local
            L1-->>LB: Cache L1 atualizado
            LB-->>Client: Resposta (latÃªncia ~15ms)
            L2->>+Monitor: Log cache hit L2
            Monitor-->>L2: MÃ©trica registrada
        else Cache L2 Miss
            L2-->>LB: âŒ Cache miss
            LB->>+Config: Buscar dados origem
            
            Config->>+Security: Validar acesso dados sensÃ­veis
            Security-->>Config: Acesso autorizado RBAC
            Note right of Security: Art. 12, II, h - Controles de acesso<br/>para proteÃ§Ã£o de dados
            
            Config-->>LB: Dados originais
            
            par AtualizaÃ§Ã£o cache paralela
                LB->>+L2: Atualizar cache distribuÃ­do
                L2-->>LB: Cache L2 atualizado
            and
                LB->>+L1: Atualizar cache local
                L1-->>LB: Cache L1 atualizado
            end
            
            LB-->>Client: Resposta (latÃªncia ~50ms)
            Config->>+Monitor: Log cache miss completo
            Monitor-->>Config: Auditoria registrada
        end
    end
    
    Monitor->>Monitor: AnÃ¡lise padrÃµes acesso
    Note right of Monitor: Art. 3Âº, Â§ 2Âº - DetecÃ§Ã£o de anomalias<br/>e prevenÃ§Ã£o de intrusÃ£o
    
    alt PadrÃ£o suspeito detectado
        Monitor->>+Security: Alerta seguranÃ§a
        Security->>Security: Aplicar circuit breaker
        Security-->>Monitor: Medidas aplicadas
        Note right of Security: ProteÃ§Ã£o proativa contra<br/>softwares maliciosos (Art. 3Âº, Â§ 2Âº)
    end
    
    Note over Client, Security: âœ… Conformidade CMN 4.893/2021:<br/>â€¢ Criptografia end-to-end<br/>â€¢ Controles de acesso RBAC<br/>â€¢ DetecÃ§Ã£o de anomalias<br/>â€¢ Auditoria completa<br/>â€¢ SegregaÃ§Ã£o de dados
